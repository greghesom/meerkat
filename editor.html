<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <title>Meerkat - Live Syntax Editor</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html, body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f5f5f5;
        height: 100%;
        overflow: hidden;
      }

      .page-wrapper {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 20px;
        background: white;
        border-bottom: 1px solid #e0e0e0;
        flex-shrink: 0;
      }

      .header h1 {
        font-size: 20px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .header h1 a {
        color: inherit;
        text-decoration: none;
      }

      .header-controls {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .header-controls select {
        padding: 8px 12px;
        font-size: 14px;
        border: 1px solid #ddd;
        border-radius: 6px;
        min-width: 200px;
        cursor: pointer;
      }

      .header-controls select:focus {
        outline: none;
        border-color: #3b82f6;
      }

      .header-controls button {
        padding: 8px 16px;
        font-size: 14px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .btn-primary {
        background: #3b82f6;
        color: white;
        border: none;
      }

      .btn-primary:hover {
        background: #2563eb;
      }

      .btn-secondary {
        background: white;
        color: #333;
        border: 1px solid #ddd;
      }

      .btn-secondary:hover {
        background: #f5f5f5;
      }

      .main-content {
        flex: 1;
        min-height: 0;
        display: flex;
      }

      .editor-section {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: #1e1e1e;
      }

      .editor-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: #252526;
        border-bottom: 1px solid #3c3c3c;
      }

      .editor-header-title {
        font-size: 12px;
        font-weight: 500;
        color: #cccccc;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .error-indicator {
        display: none;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #f48771;
        padding: 4px 8px;
        background: rgba(244, 135, 113, 0.1);
        border-radius: 4px;
      }

      .error-indicator.visible {
        display: flex;
      }

      .error-indicator svg {
        width: 14px;
        height: 14px;
      }

      .editor-container {
        flex: 1;
        min-height: 0;
      }

      .preview-section {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: white;
      }

      .preview-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: #f9fafb;
        border-bottom: 1px solid #e9ecef;
      }

      .preview-header-title {
        font-size: 12px;
        font-weight: 500;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .zoom-controls {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .zoom-controls button {
        width: 28px;
        height: 28px;
        padding: 0;
        font-size: 14px;
        font-weight: bold;
        border-radius: 4px;
        background: #fff;
        color: #333;
        border: 1px solid #ddd;
        cursor: pointer;
      }

      .zoom-controls button:hover {
        background: #f0f0f0;
      }

      .zoom-controls .zoom-level {
        min-width: 40px;
        text-align: center;
        font-size: 11px;
        color: #666;
      }

      .preview-container {
        flex: 1;
        min-height: 0;
        overflow: auto;
        padding: 20px;
      }

      #diagram-container {
        display: inline-block;
        min-width: 100%;
        transform-origin: top left;
      }

      /* SVG diagram styles */
      .sequence-diagram .participant-box {
        fill: #fff;
        stroke: #333;
        stroke-width: 2;
      }

      .sequence-diagram .participant-label {
        font-size: 14px;
        font-weight: 500;
        fill: #333;
      }

      .sequence-diagram .message-label {
        font-size: 12px;
      }

      .sequence-diagram .lifeline {
        stroke: #ddd;
        stroke-width: 1;
        stroke-dasharray: 5, 5;
      }

      /* API Path Badge styles */
      .sequence-diagram .api-path-badge {
        cursor: pointer;
      }

      .sequence-diagram .http-method {
        font-family: monospace;
        font-weight: 600;
      }

      .sequence-diagram .http-method-get { fill: #61affe; }
      .sequence-diagram .http-method-post { fill: #49cc90; }
      .sequence-diagram .http-method-put { fill: #fca130; }
      .sequence-diagram .http-method-delete { fill: #f93e3e; }
      .sequence-diagram .http-method-patch { fill: #50e3c2; }

      .sequence-diagram .api-path {
        fill: #f0f0f0;
        stroke: #cccccc;
      }

      /* Request Type Badge styles */
      .sequence-diagram .request-type-badge {
        cursor: pointer;
      }

      .sequence-diagram .request-type {
        font-family: monospace;
        font-weight: 600;
      }

      .sequence-diagram .request-type-json { fill: #4caf50; }
      .sequence-diagram .request-type-soap { fill: #ff9800; }
      .sequence-diagram .request-type-xml { fill: #9c27b0; }
      .sequence-diagram .request-type-rfc-sap { fill: #1976d2; }
      .sequence-diagram .request-type-graphql { fill: #e535ab; }
      .sequence-diagram .request-type-grpc { fill: #244c5a; }
      .sequence-diagram .request-type-binary { fill: #607d8b; }

      /* Sync/Async indicator styles */
      .sequence-diagram .async-icon {
        cursor: pointer;
      }

      .sequence-diagram .sync-async-indicator {
        cursor: pointer;
      }

      /* Payload badge styles */
      .sequence-diagram .payload-badge {
        cursor: pointer;
      }

      .sequence-diagram .payload-request-bg {
        fill: #2196f3;
      }

      .sequence-diagram .payload-response-bg {
        fill: #4caf50;
      }

      /* Flow visibility styles */
      .sequence-diagram .flow-hidden {
        opacity: 0.15;
        pointer-events: none;
      }

      .status-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 4px 12px;
        background: #007acc;
        color: white;
        font-size: 12px;
        flex-shrink: 0;
      }

      .status-bar-left,
      .status-bar-right {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .back-link {
        color: #3b82f6;
        text-decoration: none;
        font-size: 14px;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      /* Copilot toggle button */
      .copilot-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        background: #7c3aed;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background 0.15s ease;
      }

      .copilot-toggle:hover {
        background: #6d28d9;
      }

      .copilot-toggle svg {
        width: 16px;
        height: 16px;
      }

      /* Main layout with copilot sidebar */
      .main-layout {
        display: flex;
        flex: 1;
        min-height: 0;
      }

      .main-content {
        flex: 1;
        min-height: 0;
        display: flex;
      }

      .copilot-sidebar {
        width: 350px;
        min-width: 300px;
        max-width: 450px;
        border-left: 1px solid #3c3c3c;
        display: none;
      }

      .copilot-sidebar.visible {
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="page-wrapper">
      <header class="header">
        <h1>
          <a href="index.html">Meerkat</a>
          <span style="color: #999; font-weight: normal;">/ Live Editor</span>
        </h1>
        <div class="header-controls">
          <select id="diagram-select">
            <option value="">Select a diagram...</option>
          </select>
          <button id="reset-btn" class="btn-secondary">Reset</button>
          <button id="copilot-toggle-btn" class="copilot-toggle" title="Toggle Copilot Assistant">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <span>Copilot</span>
          </button>
        </div>
      </header>

      <div class="main-layout">
        <div class="main-content" id="split-pane-container">
          <!-- Split pane will be injected here -->
        </div>
        <div class="copilot-sidebar" id="copilot-sidebar">
          <!-- Copilot panel will be injected here -->
        </div>
      </div>

      <div class="status-bar">
        <div class="status-bar-left">
          <span class="status-item" id="status-messages">Messages: 0</span>
          <span class="status-item" id="status-participants">Participants: 0</span>
        </div>
        <div class="status-bar-right">
          <span class="status-item" id="status-position">Ln 1, Col 1</span>
        </div>
      </div>
    </div>

    <script type="module">
      import { 
        SequenceVisualizer, 
        Lexer, 
        Parser,
        SyntaxEditor,
        SplitPane,
        CopilotPanel,
        diagramStorage,
      } from './src/index.js';

      // State
      let config = null;
      let currentDiagramData = null;
      let currentDiagramId = null;
      let currentAST = null;
      let hasError = false;

      // DOM elements
      const splitPaneContainer = document.getElementById('split-pane-container');
      const copilotSidebar = document.getElementById('copilot-sidebar');
      const copilotToggleBtn = document.getElementById('copilot-toggle-btn');
      const diagramSelect = document.getElementById('diagram-select');
      const resetBtn = document.getElementById('reset-btn');
      const statusMessages = document.getElementById('status-messages');
      const statusParticipants = document.getElementById('status-participants');
      const statusPosition = document.getElementById('status-position');

      // Create editor section HTML
      function createEditorSection() {
        const section = document.createElement('div');
        section.className = 'editor-section';
        section.innerHTML = `
          <div class="editor-header">
            <span class="editor-header-title">Editor</span>
            <div id="error-indicator" class="error-indicator">
              <svg viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 1a7 7 0 100 14A7 7 0 008 1zm0 12.5a.75.75 0 110-1.5.75.75 0 010 1.5zM8.75 9.5a.75.75 0 01-1.5 0v-4a.75.75 0 011.5 0v4z"/>
              </svg>
              <span id="error-message">Syntax error</span>
            </div>
          </div>
          <div class="editor-container" id="editor-container"></div>
        `;
        return section;
      }

      // Create preview section HTML
      function createPreviewSection() {
        const section = document.createElement('div');
        section.className = 'preview-section';
        section.innerHTML = `
          <div class="preview-header">
            <span class="preview-header-title">Preview</span>
            <div class="zoom-controls">
              <button id="zoom-out" title="Zoom Out">âˆ’</button>
              <span id="zoom-level" class="zoom-level">100%</span>
              <button id="zoom-in" title="Zoom In">+</button>
              <button id="zoom-fit" title="Fit to Width">Fit</button>
            </div>
          </div>
          <div class="preview-container" id="preview-container">
            <div id="diagram-container"></div>
          </div>
        `;
        return section;
      }

      // Initialize split pane
      const editorSection = createEditorSection();
      const previewSection = createPreviewSection();

      const splitPane = new SplitPane(splitPaneContainer, {
        initialSplit: 0.4,
        minPaneSize: 300,
        leftContent: editorSection,
        rightContent: previewSection,
      });

      // Initialize syntax editor
      const syntaxEditor = new SyntaxEditor('#editor-container', {
        debounceDelay: 300,
        onChange: (source) => {
          renderDiagram(source);
          saveEdit(source);
        },
      });

      // Initialize visualizer
      const visualizer = new SequenceVisualizer('#diagram-container', {
        theme: 'light',
      });

      // Zoom controls
      let currentZoom = 1;
      const MIN_ZOOM = 0.25;
      const MAX_ZOOM = 3;
      const ZOOM_STEP = 0.25;
      const diagramContainer = document.getElementById('diagram-container');
      const previewContainer = document.getElementById('preview-container');
      const zoomLevelDisplay = document.getElementById('zoom-level');
      const errorIndicator = document.getElementById('error-indicator');
      const errorMessage = document.getElementById('error-message');

      function updateZoom(newZoom) {
        currentZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, newZoom));
        diagramContainer.style.transform = `scale(${currentZoom})`;
        zoomLevelDisplay.textContent = `${Math.round(currentZoom * 100)}%`;
      }

      function fitToWidth() {
        const svg = diagramContainer.querySelector('svg');
        if (svg && previewContainer) {
          const svgWidth = parseFloat(svg.getAttribute('width')) || 0;
          const containerWidth = previewContainer.clientWidth - 40; // padding
          if (svgWidth > 0 && containerWidth > 0) {
            updateZoom(containerWidth / svgWidth);
          }
        }
      }

      document.getElementById('zoom-in').addEventListener('click', () => updateZoom(currentZoom + ZOOM_STEP));
      document.getElementById('zoom-out').addEventListener('click', () => updateZoom(currentZoom - ZOOM_STEP));
      document.getElementById('zoom-fit').addEventListener('click', fitToWidth);

      // Mouse wheel zoom
      previewContainer.addEventListener('wheel', (e) => {
        if (e.ctrlKey || e.metaKey) {
          e.preventDefault();
          const delta = e.deltaY > 0 ? -0.1 : 0.1;
          updateZoom(currentZoom + delta);
        }
      }, { passive: false });

      // Track cursor position
      const textarea = syntaxEditor.textareaElement;
      if (textarea) {
        textarea.addEventListener('keyup', updateCursorPosition);
        textarea.addEventListener('click', updateCursorPosition);
      }

      function updateCursorPosition() {
        const textarea = syntaxEditor.textareaElement;
        if (!textarea) return;

        const value = textarea.value;
        const selectionStart = textarea.selectionStart;
        const lines = value.substring(0, selectionStart).split('\n');
        const line = lines.length;
        const col = lines[lines.length - 1].length + 1;

        statusPosition.textContent = `Ln ${line}, Col ${col}`;
      }

      // Render diagram
      function renderDiagram(source) {
        try {
          const lexer = new Lexer(source);
          const tokens = lexer.tokenize();
          const parser = new Parser(tokens);
          currentAST = parser.parse();

          // Render the diagram
          visualizer.renderer.render(currentAST);

          // Update status bar
          statusMessages.textContent = `Messages: ${currentAST.messages.length}`;
          statusParticipants.textContent = `Participants: ${currentAST.participants.length}`;

          // Clear errors
          hasError = false;
          syntaxEditor.clearErrors();
          errorIndicator.classList.remove('visible');

          // Fit to width after initial render
          setTimeout(fitToWidth, 50);

          return true;
        } catch (error) {
          hasError = true;
          errorIndicator.classList.add('visible');
          errorMessage.textContent = error.message || 'Syntax error';

          // Try to extract line number from error
          const lineMatch = error.message?.match(/line (\d+)/i);
          if (lineMatch) {
            syntaxEditor.setErrorLines([parseInt(lineMatch[1], 10)]);
          }

          return false;
        }
      }

      // Save edit to local storage
      async function saveEdit(source) {
        if (currentDiagramId) {
          await diagramStorage.saveDiagramEdit(currentDiagramId, source);
        }
      }

      // Load configuration
      async function loadConfig() {
        try {
          const response = await fetch('./diagrams/config.json');
          if (!response.ok) throw new Error('Failed to load config');
          config = await response.json();
          populateDiagramSelect();
          
          // Load default diagram
          if (config.defaultDiagram) {
            diagramSelect.value = config.defaultDiagram;
            await loadDiagram(config.defaultDiagram);
          }
        } catch (error) {
          console.error('Failed to load config:', error);
        }
      }

      // Populate diagram dropdown
      async function populateDiagramSelect() {
        diagramSelect.innerHTML = '<option value="">Select a diagram...</option>';
        
        for (const d of config.diagrams) {
          try {
            const response = await fetch(`./diagrams/${d.file}`);
            if (response.ok) {
              const data = await response.json();
              const option = document.createElement('option');
              option.value = d.id;
              option.textContent = data.name || d.id;
              diagramSelect.appendChild(option);
            }
          } catch {
            const option = document.createElement('option');
            option.value = d.id;
            option.textContent = d.id;
            diagramSelect.appendChild(option);
          }
        }
      }

      // Load a diagram
      async function loadDiagram(diagramId) {
        const diagramEntry = config.diagrams.find(d => d.id === diagramId);
        if (!diagramEntry) return;

        try {
          const response = await fetch(`./diagrams/${diagramEntry.file}`);
          if (!response.ok) throw new Error('Failed to load diagram');
          
          currentDiagramData = await response.json();
          currentDiagramId = diagramId;

          // Check for saved edits
          const savedEdit = await diagramStorage.getDiagramEdit(diagramId);
          const source = savedEdit?.source || currentDiagramData.diagram;

          syntaxEditor.setValue(source);
          renderDiagram(source);
        } catch (error) {
          console.error('Failed to load diagram:', error);
        }
      }

      // Reset to original
      async function resetToOriginal() {
        if (currentDiagramData && currentDiagramId) {
          syntaxEditor.setValue(currentDiagramData.diagram);
          renderDiagram(currentDiagramData.diagram);
          await diagramStorage.clearDiagramEdit(currentDiagramId);
        }
      }

      // Event listeners
      diagramSelect.addEventListener('change', (e) => {
        if (e.target.value) {
          loadDiagram(e.target.value);
        }
      });

      resetBtn.addEventListener('click', resetToOriginal);

      // Initialize Copilot Panel
      const copilotPanel = new CopilotPanel(copilotSidebar, {
        apiKey: localStorage.getItem('meerkat_copilot_api_key') || null,
        model: localStorage.getItem('meerkat_copilot_model') || 'gpt-4o',
        getCurrentSource: () => syntaxEditor.getValue(),
        onApplyEdit: (newSource) => {
          syntaxEditor.setValue(newSource);
          renderDiagram(newSource);
          saveEdit(newSource);
        },
      });

      // Toggle Copilot sidebar
      copilotToggleBtn.addEventListener('click', () => {
        copilotSidebar.classList.toggle('visible');
        // Adjust toggle button style when active
        if (copilotSidebar.classList.contains('visible')) {
          copilotToggleBtn.style.background = '#6d28d9';
        } else {
          copilotToggleBtn.style.background = '#7c3aed';
        }
      });

      // Initialize
      loadConfig();
    </script>
  </body>
</html>
